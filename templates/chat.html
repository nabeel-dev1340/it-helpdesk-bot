{% extends "base.html" %}

{% block title %}Chat - Pingpal{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    max-height: 600px;
}

.chat-messages {
    height: calc(100% - 120px);
    overflow-y: auto;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 25px;
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
}

.message {
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
    animation: slideIn 0.3s ease-out;
}

.message.user {
    justify-content: flex-end;
}

.message.bot {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 75%;
    padding: 16px 20px;
    border-radius: 20px;
    word-wrap: break-word;
    line-height: 1.6;
    font-size: 1rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    position: relative;
}

.message-bubble:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 6px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.message.bot .message-bubble {
    background: white;
    color: #2c3e50;
    border: 1px solid #e3e6f0;
    border-bottom-left-radius: 6px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

/* Enhanced typography for bot messages */
.message.bot .message-bubble {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.message.bot .message-bubble strong {
    color: #2c3e50;
    font-weight: 600;
}

.message.bot .message-bubble h1, 
.message.bot .message-bubble h2, 
.message.bot .message-bubble h3, 
.message.bot .message-bubble h4, 
.message.bot .message-bubble h5, 
.message.bot .message-bubble h6 {
    color: #1a202c;
    margin-top: 16px;
    margin-bottom: 8px;
    font-weight: 600;
}

.message.bot .message-bubble ul, 
.message.bot .message-bubble ol {
    margin: 12px 0;
    padding-left: 20px;
}

.message.bot .message-bubble li {
    margin: 6px 0;
    line-height: 1.5;
}

.message.bot .message-bubble code {
    background: #f7fafc;
    color: #e53e3e;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    border: 1px solid #e2e8f0;
}

.message.bot .message-bubble pre {
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin: 12px 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.message.bot .message-bubble blockquote {
    border-left: 4px solid #667eea;
    padding-left: 16px;
    margin: 12px 0;
    color: #4a5568;
    font-style: italic;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 6px;
    opacity: 0.8;
}

.message.user .message-time {
    color: rgba(255, 255, 255, 0.8);
}

.typing-indicator {
    display: none;
    padding: 16px 20px;
    background: white;
    border: 1px solid #e3e6f0;
    border-radius: 20px;
    border-bottom-left-radius: 6px;
    max-width: 75%;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.typing-dots {
    display: inline-block;
}

.typing-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.quick-actions {
    margin-bottom: 20px;
}

.quick-action-btn {
    margin: 3px;
    font-size: 0.875rem;
    border-radius: 20px;
    padding: 8px 16px;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.command-output {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 16px;
    margin-top: 12px;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    max-height: 250px;
    overflow-y: auto;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
    line-height: 1.5;
}

.command-success {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.command-error {
    border-left: 4px solid #dc3545;
    background: #fff8f8;
}

.chat-input-container {
    position: relative;
    margin-top: 10px;
}

.chat-input {
    border-radius: 25px;
    padding: 14px 60px 14px 20px;
    border: 2px solid #e3e6f0;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.chat-input:focus {
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    outline: none;
}

.send-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.send-btn:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.system-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.os-badge {
    font-size: 0.875rem;
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    display: inline-block;
    margin-bottom: 12px;
    backdrop-filter: blur(10px);
}

/* Responsive design improvements */
@media (max-width: 768px) {
    .message-bubble {
        max-width: 85%;
        font-size: 0.95rem;
        padding: 14px 18px;
    }
    
    .chat-messages {
        padding: 20px;
    }
    
    .quick-action-btn {
        font-size: 0.8rem;
        padding: 6px 12px;
    }
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Pingpal Logo" class="chat-header-logo me-2">
                            <h5 class="mb-0">
                                Pingpal
                            </h5>
                        </div>
                        <div class="d-flex align-items-center">
                            <div id="connection-status" class="me-3">
                                <span class="badge bg-secondary">
                                    <i class="fas fa-circle me-1"></i>Connecting...
                                </span>
                            </div>
                            <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- System Info Card -->
                    <div id="system-info-card" class="system-info-card mx-3 mt-3">
                        <div class="os-badge">
                            <i class="fas fa-desktop me-1"></i>
                            <span id="os-type">Detecting OS...</span>
                        </div>
                        <h6 class="mb-2">Welcome to Pingpal!</h6>
                        <p class="mb-0 small">
                            I can help you troubleshoot IT issues, run system diagnostics, 
                            and provide step-by-step guidance for your system.
                        </p>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions mx-3">
                        <button class="btn btn-outline-primary btn-sm quick-action-btn" onclick="runNetworkTest()">
                            <i class="fas fa-wifi me-1"></i>Network Test
                        </button>
                        <button class="btn btn-outline-success btn-sm quick-action-btn" onclick="runSystemInfo()">
                            <i class="fas fa-server me-1"></i>System Info
                        </button>
                        <button class="btn btn-outline-info btn-sm quick-action-btn" onclick="runProcessCheck()">
                            <i class="fas fa-list me-1"></i>Processes
                        </button>
                        <button class="btn btn-outline-warning btn-sm quick-action-btn" onclick="runDiskSpaceCheck()">
                            <i class="fas fa-hdd me-1"></i>Disk Space
                        </button>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages">
                            <!-- Messages will be added here -->
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div id="typing-indicator" class="typing-indicator">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span class="ms-2">Pingpal is typing...</span>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="p-3 border-top">
                            <div class="chat-input-container">
                                <input type="text" id="message-input" class="form-control chat-input" 
                                       placeholder="Describe your IT issue..." 
                                       onkeypress="handleKeyPress(event)">
                                <button id="send-btn" class="btn btn-primary send-btn" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Quick Tools
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>System Commands</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="executeCommand('ping google.com')">
                                <i class="fas fa-wifi me-1"></i>Ping Test
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="executeCommand('nslookup google.com')">
                                <i class="fas fa-search me-1"></i>DNS Lookup
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="executeCommand('systeminfo')">
                                <i class="fas fa-info-circle me-1"></i>System Info
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Network Tools</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning btn-sm" onclick="runNetworkDiagnostics()">
                                <i class="fas fa-network-wired me-1"></i>Full Network Test
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="executeCommand('ipconfig')">
                                <i class="fas fa-ethernet me-1"></i>Network Config
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>System Health</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="executeCommand('tasklist')">
                                <i class="fas fa-list me-1"></i>Running Processes
                            </button>
                            <button class="btn btn-outline-dark btn-sm" onclick="executeCommand('dir')">
                                <i class="fas fa-folder me-1"></i>Directory Listing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
let isConnected = false;

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', function() {
    initializeSocket();
    loadSystemInfo();
});

function initializeSocket() {
    try {
        socket = io({
            transports: ['websocket', 'polling'],
            timeout: 10000
        });
        
        socket.on('connect', function() {
            isConnected = true;
            updateConnectionStatus('Connected', 'success');
            console.log('WebSocket connected successfully');
        });
        
        socket.on('disconnect', function() {
            isConnected = false;
            updateConnectionStatus('Disconnected', 'danger');
            console.log('WebSocket disconnected');
        });
        
        socket.on('connect_error', function(error) {
            console.error('WebSocket connection error:', error);
            updateConnectionStatus('Connection Failed', 'danger');
            isConnected = false;
        });
        
        socket.on('bot_response', function(data) {
            hideTypingIndicator();
            addMessage('bot', data.message, data.timestamp);
        });
        
        socket.on('error', function(data) {
            hideTypingIndicator();
            addMessage('bot', 'Sorry, I encountered an error. Please try again.', new Date().toISOString());
        });
        
        // Set a timeout to fallback to REST API if WebSocket doesn't connect
        setTimeout(function() {
            if (!isConnected) {
                console.log('WebSocket connection timeout, using REST API fallback');
                updateConnectionStatus('Using REST API', 'warning');
            }
        }, 5000);
        
    } catch (error) {
        console.error('Error initializing WebSocket:', error);
        updateConnectionStatus('WebSocket Error', 'danger');
        isConnected = false;
    }
}

function updateConnectionStatus(status, type) {
    const statusElement = document.getElementById('connection-status');
    statusElement.innerHTML = `
        <span class="badge bg-${type}">
            <i class="fas fa-circle me-1"></i>${status}
        </span>
    `;
}

function loadSystemInfo() {
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('os-type').textContent = data.os_type;
            }
        })
        .catch(error => {
            console.error('Error loading system info:', error);
        });
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send message via WebSocket if connected
    if (isConnected && socket) {
        try {
            socket.emit('send_message', { message: message });
        } catch (error) {
            console.error('WebSocket send error:', error);
            // Fallback to REST API
            sendMessageViaAPI(message);
        }
    } else {
        // Fallback to REST API
        sendMessageViaAPI(message);
    }
}

function sendMessageViaAPI(message) {
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        if (data.error) {
            addMessage('bot', 'Sorry, I encountered an error. Please try again.');
        } else {
            addMessage('bot', data.response);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
        addMessage('bot', 'Sorry, I encountered an error. Please try again.');
    });
}

function sendQuickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

function addMessage(sender, content, timestamp = null) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const time = timestamp ? new Date(timestamp) : new Date();
    const timeString = time.toLocaleTimeString();
    
    // Format content for bot messages (markdown-like formatting)
    let formattedContent = content;
    if (sender === 'bot') {
        formattedContent = formatBotMessage(content);
    }
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${formattedContent}
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function formatBotMessage(content) {
    // Use marked.js for markdown rendering
    if (typeof marked !== 'undefined') {
        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // Convert markdown to HTML
        let formatted = marked.parse(content);
        
        // Custom formatting for specific elements
        // Bold text (**text**) - ensure it's properly styled
        formatted = formatted.replace(/<strong>(.*?)<\/strong>/g, '<strong style="color: #2c3e50; font-weight: 600;">$1</strong>');
        
        // Code blocks - enhance styling
        formatted = formatted.replace(/<code>(.*?)<\/code>/g, '<code style="background: #f7fafc; color: #e53e3e; padding: 2px 6px; border-radius: 4px; font-family: \'Courier New\', monospace; font-size: 0.9em; border: 1px solid #e2e8f0;">$1</code>');
        
        // Headers - enhance styling
        formatted = formatted.replace(/<h([1-6])>(.*?)<\/h[1-6]>/g, '<h$1 style="color: #1a202c; margin-top: 16px; margin-bottom: 8px; font-weight: 600;">$2</h$1>');
        
        // Lists - enhance styling
        formatted = formatted.replace(/<ul>(.*?)<\/ul>/g, '<ul style="margin: 12px 0; padding-left: 20px;">$1</ul>');
        formatted = formatted.replace(/<ol>(.*?)<\/ol>/g, '<ol style="margin: 12px 0; padding-left: 20px;">$1</ol>');
        formatted = formatted.replace(/<li>(.*?)<\/li>/g, '<li style="margin: 6px 0; line-height: 1.5;">$1</li>');
        
        // Paragraphs - enhance spacing
        formatted = formatted.replace(/<p>(.*?)<\/p>/g, '<p style="margin: 8px 0; line-height: 1.6;">$1</p>');
        
        return formatted;
    } else {
        // Fallback to basic formatting if marked.js is not available
        let formatted = content;
        
        // Bold text (**text**)
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Code blocks (`code`)
        formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // Headers (# Header)
        formatted = formatted.replace(/^# (.*$)/gm, '<h4>$1</h4>');
        formatted = formatted.replace(/^## (.*$)/gm, '<h5>$1</h5>');
        formatted = formatted.replace(/^### (.*$)/gm, '<h6>$1</h6>');
        
        // Bullet points (• item)
        formatted = formatted.replace(/^• (.*$)/gm, '<li>$1</li>');
        
        // Numbered lists (1. item)
        formatted = formatted.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
        
        // Wrap lists in ul/ol tags
        formatted = formatted.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
        
        // Line breaks
        formatted = formatted.replace(/\n\n/g, '</p><p>');
        formatted = formatted.replace(/\n/g, '<br>');
        
        // Wrap in paragraph tags if not already wrapped
        if (!formatted.includes('<h') && !formatted.includes('<ul') && !formatted.includes('<code')) {
            formatted = `<p>${formatted}</p>`;
        }
        
        // Clean up empty paragraphs
        formatted = formatted.replace(/<p><\/p>/g, '');
        formatted = formatted.replace(/<p><br><\/p>/g, '');
        
        return formatted;
    }
}

function showTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'block';
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'none';
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        document.getElementById('chat-messages').innerHTML = '';
    }
}

function executeCommand(command) {
    fetch('/api/execute-command', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ command: command })
    })
    .then(response => response.json())
    .then(data => {
        const output = data.success ? data.output : data.error;
        const cssClass = data.success ? 'command-success' : 'command-error';
        
        addMessage('bot', `
            <strong>Command:</strong> ${command}<br>
            <div class="command-output ${cssClass}">${output}</div>
        `);
    })
    .catch(error => {
        console.error('Error:', error);
        addMessage('bot', 'Error executing command. Please try again.');
    });
}

function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        document.getElementById('chat-messages').innerHTML = '';
    }
}

function runNetworkTest() {
    addMessage('bot', '<strong>Running Network Test...</strong>');
    // Use OS-specific ping command
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('ping google.com -n 4');
    } else {
        executeCommand('ping -c 4 google.com');
    }
}

function runSystemInfo() {
    addMessage('bot', '<strong>Getting System Information...</strong>');
    // Use OS-specific system info command
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('systeminfo');
    } else if (osType.includes('darwin') || osType.includes('mac')) {
        executeCommand('system_profiler SPHardwareDataType');
    } else {
        executeCommand('uname -a && cat /etc/os-release');
    }
}

function runProcessCheck() {
    addMessage('bot', '<strong>Checking Running Processes...</strong>');
    // Use OS-specific process list command
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('tasklist');
    } else {
        executeCommand('ps aux --sort=-%cpu | head -20');
    }
}

function runDiskSpaceCheck() {
    addMessage('bot', '<strong>Checking Disk Space...</strong>');
    // Use OS-specific disk space command
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('wmic logicaldisk get size,freespace,caption');
    } else {
        executeCommand('df -h');
    }
}

function runNetworkDiagnostics() {
    fetch('/api/network-test')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addMessage('bot', `Network diagnostics failed: ${data.error}`);
            } else {
                let output = '<strong>Network Diagnostics Results:</strong><br>';
                
                if (data.connectivity) {
                    output += '<br><strong>Internet Connectivity:</strong><br>';
                    Object.entries(data.connectivity).forEach(([host, result]) => {
                        const status = result.success ? '✓' : '✗';
                        output += `${status} ${host}<br>`;
                    });
                }
                
                if (data.dns) {
                    output += '<br><strong>DNS Resolution:</strong><br>';
                    Object.entries(data.dns).forEach(([domain, result]) => {
                        const status = result.success ? '✓' : '✗';
                        output += `${status} ${domain}<br>`;
                    });
                }
                
                addMessage('bot', output);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('bot', 'Error running network diagnostics. Please try again.');
        });
}
</script>
{% endblock %} 